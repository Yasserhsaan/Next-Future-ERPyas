<Page
    x:Class="Next_Future_ERP.Features.SystemUsers.Views.SystemUsersListView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:core="clr-namespace:Next_Future_ERP.Core.Controls"
    xmlns:converters="clr-namespace:Next_Future_ERP.Features.SystemUsers.Converters"
    Title="Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…"
    FlowDirection="RightToLeft"
    Background="#F7F9FC">

    <Page.Resources>
        <!-- Ù…Ø­ÙˆÙ„Ø§Øª -->
        <converters:StatusToTextConverter x:Key="StatusToText"/>
        <converters:UserIdToNameConverter x:Key="UserIdToName"/>
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>

        <!-- Ø£Ù„ÙˆØ§Ù† Ø¹Ø§Ù…Ø© -->
        <SolidColorBrush x:Key="SapBlue" Color="#0A6ED1"/>
        <SolidColorBrush x:Key="SapPanelBorder" Color="#E5E7EB"/>

        <!-- Ø£Ù„ÙˆØ§Ù† Ø¥Ø¶Ø§ÙÙŠØ© Ù…ØªÙ†Ø§Ø³Ù‚Ø© Ù…Ø¹ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ -->
        <SolidColorBrush x:Key="Clr.Primary" Color="#0A6ED1"/>
        <SolidColorBrush x:Key="Clr.Success" Color="#0E9F6E"/>
        <SolidColorBrush x:Key="Clr.Warning" Color="#D97706"/>
        <SolidColorBrush x:Key="Clr.Danger"  Color="#DC2626"/>

        <!-- Ø²Ø± Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª -->
        <Style TargetType="Button" x:Key="ToolbarBtn">
            <Setter Property="Padding" Value="10,6"/>
            <Setter Property="Margin" Value="6,0,0,0"/>
        </Style>

        <!-- Ø²Ø± Ø­Ø§Ù„Ø© Ù…Ø¯Ù…Ø¬ Ø¨Ø£Ø³Ù„ÙˆØ¨ Chip -->
        <Style x:Key="StatusActionBtn" TargetType="Button" BasedOn="{StaticResource ToolbarBtn}">
            <Setter Property="Padding" Value="10,6"/>
            <Setter Property="MinWidth" Value="100"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Background" Value="#FFFFFF"/>
            <Setter Property="BorderBrush" Value="#E5E7EB"/>
            <Setter Property="Foreground" Value="#111827"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="SnapsToDevicePixels" Value="True"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="16" Padding="{TemplateBinding Padding}">
                            <ContentPresenter VerticalAlignment="Center" HorizontalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="BorderBrush" Value="#CBD5E1"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                                <Setter Property="Cursor" Value="Arrow"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- ØªÙ†Ø³ÙŠÙ‚ Ø¹Ø§Ù… Ù„Ù„Ù€ DataGrid -->
        <Style TargetType="DataGrid">
            <Setter Property="RowHeight" Value="36"/>
            <Setter Property="AlternationCount" Value="2"/>
            <Setter Property="AlternatingRowBackground" Value="#FAFAFA"/>
            <Setter Property="CanUserAddRows" Value="False"/>
            <Setter Property="IsReadOnly" Value="True"/>
            <Setter Property="SelectionMode" Value="Single"/>
        </Style>

        <!-- ØªÙ…ÙˆÙŠÙ‡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ + ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ØªÙØ§Ø¹Ù„ (Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± Ù…Ù†Ø·Ù‚) -->
        <Style TargetType="DockPanel" x:Key="BlurWhenLoading">
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsLoading}" Value="True">
                    <Setter Property="Effect">
                        <Setter.Value>
                            <BlurEffect Radius="6"/>
                        </Setter.Value>
                    </Setter>
                    <Setter Property="IsEnabled" Value="False"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <!-- Ø´Ø§Ø±Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
        <Style x:Key="StatusPill" TargetType="Border">
            <Setter Property="CornerRadius" Value="12"/>
            <Setter Property="Padding" Value="8,3"/>
            <Setter Property="Background" Value="#F1F5F9"/>
            <Setter Property="BorderBrush" Value="#E5E7EB"/>
            <Setter Property="BorderThickness" Value="1"/>
        </Style>
    </Page.Resources>

    <Grid Margin="12">
        <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù…Ø¹ Blur Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
        <DockPanel Style="{StaticResource BlurWhenLoading}">
            <!-- Ø´Ø±ÙŠØ· Ø£Ø¯ÙˆØ§Øª -->
            <Border DockPanel.Dock="Top" Background="#F3F4F6" CornerRadius="8" Padding="10" Margin="0,0,0,10">
                <DockPanel LastChildFill="False">
                    <core:CommandBar DockPanel.Dock="Top"
                                     NewCommand="{Binding AddUserCommand}"
                                     EditCommand="{Binding EditSelectedUserCommand}"
                                     SaveCommand="{x:Null}"
                                     DeleteCommand="{Binding DeleteUserCommand}"
                                     RefreshCommand="{Binding RefreshCommand}"
                                     SearchCommand="{Binding SearchCommand}" />

                    <!-- Ø£Ø²Ø±Ø§Ø± ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ø¨Ø§Ø´Ø±Ø© -->
                    <StackPanel Orientation="Horizontal" Margin="10,0,0,0">
                        <!-- Ù‚ÙÙ„/ÙØªØ­ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
                        <Button Content="ðŸ”’ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù‚ÙÙ„"
                                Command="{Binding ToggleLockCommand}"
                                ToolTip="Ù‚ÙÙ„/ÙØªØ­ Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø¸Ø§Ù…">
                            <Button.Style>
                                <Style TargetType="Button" BasedOn="{StaticResource StatusActionBtn}">
                                    <Setter Property="BorderBrush" Value="{StaticResource Clr.Warning}"/>
                                    <Setter Property="Foreground" Value="{StaticResource Clr.Warning}"/>
                                </Style>
                            </Button.Style>
                        </Button>

                        <!-- Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± -->
                        <Button Content="ðŸ”‘ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
                                Command="{Binding ResetPasswordCommand}"
                                ToolTip="Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                            <Button.Style>
                                <Style TargetType="Button" BasedOn="{StaticResource StatusActionBtn}">
                                    <Setter Property="BorderBrush" Value="{StaticResource Clr.Danger}"/>
                                    <Setter Property="Foreground" Value="{StaticResource Clr.Danger}"/>
                                </Style>
                            </Button.Style>
                        </Button>

                        <!-- ØªØµØ¯ÙŠØ± -->
                        <Button Content="ðŸ“Š ØªØµØ¯ÙŠØ±"
                                Command="{Binding ExportCommand}"
                                ToolTip="ØªØµØ¯ÙŠØ± Ù‚Ø§Ø¦Ù…Ø© Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…">
                            <Button.Style>
                                <Style TargetType="Button" BasedOn="{StaticResource StatusActionBtn}">
                                    <Setter Property="BorderBrush" Value="{StaticResource Clr.Success}"/>
                                    <Setter Property="Foreground" Value="{StaticResource Clr.Success}"/>
                                </Style>
                            </Button.Style>
                        </Button>
                    </StackPanel>
                </DockPanel>
            </Border>

            <!-- Ø´Ø±ÙŠØ· Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª -->
            <Border DockPanel.Dock="Top" Background="#E5F3FF" CornerRadius="4" Padding="8,4" Margin="0,0,0,8">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="ðŸ“Š" FontSize="14" Margin="0,0,8,0"/>
                    <TextBlock Text="{Binding StatusMessage}" 
                               FontSize="12" 
                               Foreground="#0A6ED1" 
                               FontWeight="SemiBold"/>
                </StackPanel>
            </Border>

            <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© -->
            <DataGrid ItemsSource="{Binding Users}"
                      SelectedItem="{Binding SelectedUser, Mode=TwoWay}"
                      AutoGenerateColumns="False"
                      MouseDoubleClick="DataGrid_MouseDoubleClick">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Ø§Ù„Ø±Ù‚Ù…" Binding="{Binding Id}" Width="80"/>
                    <DataGridTextColumn Header="Ø§Ù„ÙƒÙˆØ¯" Binding="{Binding Code}" Width="100"/>
                    <DataGridTextColumn Header="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" Binding="{Binding FullName}" Width="200"/>
                    <DataGridTextColumn Header="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" Binding="{Binding Email}" Width="200"/>
                    <DataGridTextColumn Header="Ø§Ù„Ø¬ÙˆØ§Ù„" Binding="{Binding Mobile}" Width="120"/>
                    <DataGridTextColumn Header="Ø§Ù„Ù‡Ø§ØªÙ" Binding="{Binding Phone}" Width="120"/>
                    
                    <!-- Ø¹Ù…ÙˆØ¯ Ø§Ù„ÙØ±Ø¹ -->
                    <DataGridTextColumn Header="Ø§Ù„ÙØ±Ø¹" Binding="{Binding BranchName}" Width="150"/>
                    
                    <!-- Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¯ÙˆØ± -->
                    <DataGridTextColumn Header="Ø§Ù„Ø¯ÙˆØ±" Binding="{Binding RoleName}" Width="120"/>

                    <!-- Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø­Ø§Ù„Ø©: Ù…Ù‚ÙÙ„/Ù…ÙØªÙˆØ­ -->
                    <DataGridTemplateColumn Header="Ø§Ù„Ø­Ø§Ù„Ø©" Width="140">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Border x:Name="Pill" Style="{StaticResource StatusPill}">
                                    <TextBlock FontSize="12" FontWeight="SemiBold"
                                               Foreground="#111827"
                                               Text="{Binding StatusText}"/>
                                </Border>
                                <DataTemplate.Triggers>
                                    <!-- Ù…ÙØªÙˆØ­ -->
                                    <DataTrigger Binding="{Binding IsLocked}" Value="False">
                                        <Setter TargetName="Pill" Property="Background" Value="#ECFDF5"/>
                                        <Setter TargetName="Pill" Property="BorderBrush" Value="#A7F3D0"/>
                                    </DataTrigger>
                                    <!-- Ù…Ù‚ÙÙ„ -->
                                    <DataTrigger Binding="{Binding IsLocked}" Value="True">
                                        <Setter TargetName="Pill" Property="Background" Value="#FEF2F2"/>
                                        <Setter TargetName="Pill" Property="BorderBrush" Value="#FECACA"/>
                                    </DataTrigger>
                                </DataTemplate.Triggers>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <DataGridTextColumn Header="Ø¢Ø®Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„" Binding="{Binding LastLoginText}" Width="150"/>
                    <DataGridTextColumn Header="Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„ÙØ§Ø´Ù„Ø©" Binding="{Binding FailedLoginAttempts}" Width="120"/>
                </DataGrid.Columns>

                <DataGrid.ContextMenu>
                    <ContextMenu>
                        <MenuItem Header="ØªØ¹Ø¯ÙŠÙ„"
                                  Command="{Binding DataContext.EditUserCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"/>
                        <MenuItem Header="Ø­Ø°Ù"
                                  Command="{Binding DataContext.DeleteUserCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"/>
                        <Separator/>
                        <MenuItem Header="Ù‚ÙÙ„/ÙØªØ­ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"
                                  Command="{Binding DataContext.ToggleLockCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"/>
                        <MenuItem Header="Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
                                  Command="{Binding DataContext.ResetPasswordCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"/>
                    </ContextMenu>
                </DataGrid.ContextMenu>
            </DataGrid>
        </DockPanel>

        <!-- Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø£Ø³Ù„ÙˆØ¨ SAP ByDesign -->
        <Grid Background="#1A000000" Panel.ZIndex="99">
            <Grid.Style>
                <Style TargetType="Grid">
                    <!-- Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹: Visible -->
                    <Setter Property="Visibility" Value="Visible"/>
                    <Style.Triggers>
                        <!-- Ø¹Ù†Ø¯Ù…Ø§ ØªÙ†ØªÙ‡ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
                        <DataTrigger Binding="{Binding IsLoading}" Value="False">
                            <Setter Property="Visibility" Value="Collapsed"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Grid.Style>

            <!-- Ø¨Ø·Ø§Ù‚Ø© Ø®ÙÙŠÙØ© ÙˆØ³Ø· Ø§Ù„Ø´Ø§Ø´Ø© -->
            <Border HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Background="White"
                    CornerRadius="8"
                    Padding="18"
                    BorderBrush="{StaticResource SapPanelBorder}"
                    BorderThickness="1">
                <StackPanel Orientation="Vertical" HorizontalAlignment="Center">

                    <!-- Spinner Ù†Ù‚Ø·ÙŠ ÙŠØ¯ÙˆØ± -->
                    <Grid Width="42" Height="42" RenderTransformOrigin="0.5,0.5" Margin="0,0,0,10">
                        <Grid.RenderTransform>
                            <RotateTransform Angle="0"/>
                        </Grid.RenderTransform>

                        <!-- 8 Ù†Ù‚Ø§Ø· Ø­ÙˆÙ„ Ø¯Ø§Ø¦Ø±Ø© Ø¨Ø¯Ø±Ø¬Ø§Øª Ø´ÙØ§ÙÙŠØ© -->
                        <Ellipse Width="6" Height="6" Fill="{StaticResource SapBlue}" Opacity="1"   HorizontalAlignment="Center" VerticalAlignment="Top"/>
                        <Ellipse Width="6" Height="6" Fill="{StaticResource SapBlue}" Opacity="0.9" HorizontalAlignment="Right" VerticalAlignment="Top"    Margin="0,6,6,0"/>
                        <Ellipse Width="6" Height="6" Fill="{StaticResource SapBlue}" Opacity="0.8" HorizontalAlignment="Right" VerticalAlignment="Center"/>
                        <Ellipse Width="6" Height="6" Fill="{StaticResource SapBlue}" Opacity="0.7" HorizontalAlignment="Right" VerticalAlignment="Bottom"  Margin="0,0,6,6"/>
                        <Ellipse Width="6" Height="6" Fill="{StaticResource SapBlue}" Opacity="0.6" HorizontalAlignment="Center" VerticalAlignment="Bottom"/>
                        <Ellipse Width="6" Height="6" Fill="{StaticResource SapBlue}" Opacity="0.5" HorizontalAlignment="Left"  VerticalAlignment="Bottom"  Margin="6,0,0,6"/>
                        <Ellipse Width="6" Height="6" Fill="{StaticResource SapBlue}" Opacity="0.45" HorizontalAlignment="Left"  VerticalAlignment="Center"/>
                        <Ellipse Width="6" Height="6" Fill="{StaticResource SapBlue}" Opacity="0.4" HorizontalAlignment="Left"  VerticalAlignment="Top"     Margin="6,6,0,0"/>

                        <!-- Ø­Ø±ÙƒØ© Ø§Ù„Ø¯ÙˆØ±Ø§Ù† -->
                        <Grid.Triggers>
                            <EventTrigger RoutedEvent="Grid.Loaded">
                                <BeginStoryboard>
                                    <Storyboard RepeatBehavior="Forever">
                                        <DoubleAnimation
                                            Storyboard.TargetProperty="(UIElement.RenderTransform).(RotateTransform.Angle)"
                                            From="0" To="360" Duration="0:0:1.2" />
                                    </Storyboard>
                                </BeginStoryboard>
                            </EventTrigger>
                        </Grid.Triggers>
                    </Grid>

                    <!-- Ù†ØµÙˆØµ Ù‡Ø§Ø¯Ø¦Ø© ØµØºÙŠØ±Ø© Ù…Ø«Ù„ ByDesign -->
                    <TextBlock Text="Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©..."
                               FontSize="12"
                               Foreground="#2B2F33"
                               HorizontalAlignment="Center"
                               Margin="0,0,0,2"/>
                    <TextBlock Text="ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±"
                               FontSize="11"
                               Foreground="#6B7280"
                               HorizontalAlignment="Center"/>
                </StackPanel>
            </Border>
        </Grid>
    </Grid>
</Page>
