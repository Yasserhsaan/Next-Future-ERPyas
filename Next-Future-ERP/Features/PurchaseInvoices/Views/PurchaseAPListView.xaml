<Page
    x:Class="Next_Future_ERP.Features.PurchaseInvoices.Views.PurchaseAPListView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:core="clr-namespace:Next_Future_ERP.Core.Controls"
      xmlns:converters="clr-namespace:Next_Future_ERP.Features.PurchaseInvoices.Converters"
      Title="فواتير المشتريات والمرتجعات"
      FlowDirection="RightToLeft"
      Background="#F7F9FC">

    <Page.Resources>
        <!-- محولات -->
        <converters:StatusToTextConverter x:Key="StatusToText"/>
        <converters:DocTypeToTextConverter x:Key="DocTypeToTextConverter"/>
        <converters:StringToVisibilityConverter x:Key="StringToVisibilityConverter"/>
        <converters:SupplierIdToNameConverter x:Key="SupplierIdToName"/>
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>

        <!-- ألوان عامة -->
        <SolidColorBrush x:Key="SapBlue" Color="#0A6ED1"/>
        <SolidColorBrush x:Key="SapPanelBorder" Color="#E5E7EB"/>

        <!-- ألوان إضافية متناسقة مع نافذة التعديل -->
        <SolidColorBrush x:Key="Clr.Primary" Color="#0A6ED1"/>
        <SolidColorBrush x:Key="Clr.Success" Color="#0E9F6E"/>
        <SolidColorBrush x:Key="Clr.Warning" Color="#D97706"/>
        <SolidColorBrush x:Key="Clr.Danger"  Color="#DC2626"/>

        <!-- زر شريط الأدوات -->
        <Style TargetType="Button" x:Key="ToolbarBtn">
            <Setter Property="Padding" Value="10,6"/>
            <Setter Property="Margin" Value="6,0,0,0"/>
        </Style>

        <!-- زر حالة مدمج بأسلوب Chip -->
        <Style x:Key="StatusActionBtn" TargetType="Button" BasedOn="{StaticResource ToolbarBtn}">
            <Setter Property="Padding" Value="10,6"/>
            <Setter Property="MinWidth" Value="100"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Background" Value="#FFFFFF"/>
            <Setter Property="BorderBrush" Value="#E5E7EB"/>
            <Setter Property="Foreground" Value="#111827"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="SnapsToDevicePixels" Value="True"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="16" Padding="{TemplateBinding Padding}">
                            <ContentPresenter VerticalAlignment="Center" HorizontalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="BorderBrush" Value="#CBD5E1"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                                <Setter Property="Cursor" Value="Arrow"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        
        <!-- تنسيق عام للـ DataGrid -->
        <Style TargetType="DataGrid">
            <Setter Property="RowHeight" Value="36"/>
            <Setter Property="AlternationCount" Value="2"/>
            <Setter Property="AlternatingRowBackground" Value="#FAFAFA"/>
            <Setter Property="CanUserAddRows" Value="False"/>
            <Setter Property="IsReadOnly" Value="True"/>
            <Setter Property="SelectionMode" Value="Single"/>
        </Style>

        <!-- تمويه المحتوى أثناء التحميل + تعطيل التفاعل (بدون تغيير منطق) -->
        <Style TargetType="DockPanel" x:Key="BlurWhenLoading">
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsLoading}" Value="True">
                    <Setter Property="Effect">
                        <Setter.Value>
                            <BlurEffect Radius="6"/>
                        </Setter.Value>
                    </Setter>
                    <Setter Property="IsEnabled" Value="False"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <!-- شارة الحالة داخل الجدول -->
        <Style x:Key="StatusPill" TargetType="Border">
            <Setter Property="CornerRadius" Value="12"/>
            <Setter Property="Padding" Value="8,3"/>
            <Setter Property="Background" Value="#F1F5F9"/>
            <Setter Property="BorderBrush" Value="#E5E7EB"/>
            <Setter Property="BorderThickness" Value="1"/>
        </Style>
    </Page.Resources>

    <Grid Margin="12">
        <!-- المحتوى الرئيسي مع Blur أثناء التحميل -->
        <DockPanel Style="{StaticResource BlurWhenLoading}">
            <!-- شريط أدوات -->
            <Border DockPanel.Dock="Top" Background="#F3F4F6" CornerRadius="8" Padding="10" Margin="0,0,0,10">
                <DockPanel LastChildFill="False">
                    <core:CommandBar DockPanel.Dock="Top"
                                     NewCommand="{Binding NewInvoiceCommand}"
                                     EditCommand="{Binding EditDialogCommand}"
                                     SaveCommand="{x:Null}"
                                     DeleteCommand="{Binding DeleteCommand}"
                                     RefreshCommand="{Binding RefreshCommand}"
                                     SearchCommand="{Binding LoadCommand}" />

                    <!-- أزرار تغيير الحالة مباشرة -->
                    <StackPanel Orientation="Horizontal" Margin="10,0,0,0">
                        <!-- ترحيل: مفعّل فقط إذا الحالة = 0 (مسودة) -->
                        <Button Content="↪ ترحيل"
                                Command="{Binding PostCommand}"
                                ToolTip="ترحيل المستند (مسودة → مرحل)">
                            <Button.Style>
                                <Style TargetType="Button" BasedOn="{StaticResource StatusActionBtn}">
                                    <Setter Property="BorderBrush" Value="{StaticResource Clr.Primary}"/>
                                    <Setter Property="Foreground" Value="{StaticResource Clr.Primary}"/>
                                </Style>
                            </Button.Style>
                        </Button>

                        <!-- عكس الترحيل: مفعّل فقط إذا الحالة = 1 (مرحل) -->
                        <Button Content="↩ عكس الترحيل"
                                Command="{Binding UnpostCommand}"
                                ToolTip="عكس ترحيل المستند (مرحل → مسودة)">
                            <Button.Style>
                                <Style TargetType="Button" BasedOn="{StaticResource StatusActionBtn}">
                                    <Setter Property="BorderBrush" Value="{StaticResource Clr.Warning}"/>
                                    <Setter Property="Foreground" Value="{StaticResource Clr.Warning}"/>
                                </Style>
                            </Button.Style>
                        </Button>

                        <!-- فاتورة جديدة -->
                        <Button Content="فاتورة جديدة"
                                Command="{Binding NewInvoiceCommand}"
                                ToolTip="إنشاء فاتورة مشتريات جديدة">
                            <Button.Style>
                                <Style TargetType="Button" BasedOn="{StaticResource StatusActionBtn}">
                                    <Setter Property="BorderBrush" Value="{StaticResource Clr.Success}"/>
                                    <Setter Property="Foreground" Value="{StaticResource Clr.Success}"/>
                                </Style>
                            </Button.Style>
                        </Button>

                        <!-- مرتجع جديد -->
                        <Button Content="مرتجع جديد"
                                Command="{Binding NewReturnCommand}"
                                ToolTip="إنشاء مرتجع مشتريات جديد">
                            <Button.Style>
                                <Style TargetType="Button" BasedOn="{StaticResource StatusActionBtn}">
                                    <Setter Property="BorderBrush" Value="{StaticResource Clr.Danger}"/>
                                    <Setter Property="Foreground" Value="{StaticResource Clr.Danger}"/>
                                </Style>
                            </Button.Style>
                        </Button>
                    </StackPanel>

                    <!-- فلاتر البحث -->
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="20,0,0,0">
                    <ComboBox ItemsSource="{Binding Suppliers}"
                              SelectedItem="{Binding SelectedSupplier}"
                              DisplayMemberPath="SupplierName"
                                  ToolTip="فلترة بالمورد"/>
                    
                        <ComboBox Width="120" SelectionChanged="DocTypeComboBox_SelectionChanged" ToolTip="فلترة بالنوع">
                        <ComboBoxItem Content="فاتورة مشتريات"/>
                        <ComboBoxItem Content="مرتجع مشتريات"/>
                        <ComboBoxItem Content="الكل"/>
                    </ComboBox>
                    
                        <DatePicker SelectedDate="{Binding FromDate}"
                                    ToolTip="من تاريخ"/>
                    
                        <DatePicker SelectedDate="{Binding ToDate}"
                                    ToolTip="إلى تاريخ"/>
                </StackPanel>
                </DockPanel>
        </Border>

            <!-- القائمة -->
            <DataGrid ItemsSource="{Binding Items}"
                      SelectedItem="{Binding SelectedItem, Mode=TwoWay}"
                      AutoGenerateColumns="False"
                      MouseDoubleClick="DataGrid_MouseDoubleClick"
                      LoadingRow="DataGrid_LoadingRow">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="رقم المستند" Binding="{Binding DocNumber}" Width="160"/>
                    <DataGridTextColumn Header="النوع" Binding="{Binding DocType, Converter={StaticResource DocTypeToTextConverter}}" Width="120"/>
                    <DataGridTextColumn Header="التاريخ" Binding="{Binding DocDate, StringFormat={}{0:yyyy-MM-dd}}" Width="140"/>
                    <DataGridTemplateColumn Header="المورد" Width="220">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock>
                                    <TextBlock.Text>
                                        <MultiBinding Converter="{StaticResource SupplierIdToName}">
                                            <!-- 1) المعرّف -->
                                            <Binding Path="SupplierId"/>
                                            <!-- 2) مرجع القائمة -->
                                            <Binding Path="DataContext.Suppliers"
                                                     RelativeSource="{RelativeSource AncestorType=DataGrid}"/>
                                            <!-- 3) لإجبار إعادة الحساب -->
                                            <Binding Path="DataContext.Suppliers.Count"
                                                     RelativeSource="{RelativeSource AncestorType=DataGrid}"/>
                                        </MultiBinding>
                                    </TextBlock.Text>
                                </TextBlock>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    <DataGridTextColumn Header="رقم المرجع" Binding="{Binding ReferenceNumber}" Width="140"/>

                    <!-- عمود الحالة: شارة ملوّنة -->
                    <DataGridTemplateColumn Header="الحالة" Width="140">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Border x:Name="Pill" Style="{StaticResource StatusPill}">
                                    <TextBlock FontSize="12" FontWeight="SemiBold"
                                               Foreground="#111827"
                                               Text="{Binding Status, Converter={StaticResource StatusToText}}"/>
                                </Border>
                                <DataTemplate.Triggers>
                                    <!-- مسودة -->
                                    <DataTrigger Binding="{Binding Status}" Value="0">
                                        <Setter TargetName="Pill" Property="Background" Value="#F3F4F6"/>
                                        <Setter TargetName="Pill" Property="BorderBrush" Value="#E5E7EB"/>
                                    </DataTrigger>
                                    <!-- محفوظ -->
                                    <DataTrigger Binding="{Binding Status}" Value="1">
                                        <Setter TargetName="Pill" Property="Background" Value="#EFF6FF"/>
                                        <Setter TargetName="Pill" Property="BorderBrush" Value="#BFDBFE"/>
                                    </DataTrigger>
                                    <!-- مرحل -->
                                    <DataTrigger Binding="{Binding Status}" Value="2">
                                        <Setter TargetName="Pill" Property="Background" Value="#ECFDF5"/>
                                        <Setter TargetName="Pill" Property="BorderBrush" Value="#A7F3D0"/>
                                    </DataTrigger>
                                    <!-- ملغي -->
                                    <DataTrigger Binding="{Binding Status}" Value="9">
                                        <Setter TargetName="Pill" Property="Background" Value="#FEF2F2"/>
                                        <Setter TargetName="Pill" Property="BorderBrush" Value="#FECACA"/>
                                    </DataTrigger>
                                </DataTemplate.Triggers>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                        <DataGridTemplateColumn.CellEditingTemplate>
                            <DataTemplate>
                                <Border Style="{StaticResource StatusPill}">
                                    <TextBlock FontSize="12" FontWeight="SemiBold"
                                               Foreground="#111827"
                                               Text="{Binding Status, Converter={StaticResource StatusToText}}"/>
                                </Border>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellEditingTemplate>
                    </DataGridTemplateColumn>

                    <DataGridTextColumn Header="المجموع الفرعي" Binding="{Binding SubTotal, StringFormat={}{0:N2}}" Width="140"/>
                    <DataGridTextColumn Header="الضريبة" Binding="{Binding TaxAmount, StringFormat={}{0:N2}}" Width="120"/>
                    <DataGridTextColumn Header="الإجمالي" Binding="{Binding TotalAmount, StringFormat={}{0:N2}}" Width="140"/>
                    <DataGridTextColumn Header="الوصف" Binding="{Binding Remarks}" Width="*"/>
                </DataGrid.Columns>

                <DataGrid.ContextMenu>
                    <ContextMenu>
                        <MenuItem Header="تعديل"
                                  Command="{Binding DataContext.EditDialogCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"/>
                        <MenuItem Header="فاتورة جديدة"
                                  Command="{Binding DataContext.NewInvoiceCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"/>
                        <MenuItem Header="مرتجع جديد"
                                  Command="{Binding DataContext.NewReturnCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"/>
                        <MenuItem Header="ترحيل"
                                  Command="{Binding DataContext.PostCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"/>
                        <MenuItem Header="عكس الترحيل"
                                  Command="{Binding DataContext.UnpostCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"/>
                        <Separator/>
                        <MenuItem Header="حذف"
                                  Command="{Binding DataContext.DeleteCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"/>
                    </ContextMenu>
                </DataGrid.ContextMenu>
            </DataGrid>
        </DockPanel>

        <!-- مؤشر التحميل بأسلوب SAP ByDesign
             - يظهر افتراضياً عند فتح الصفحة
             - يختفي عندما IsLoading = False
             - لا تغيير في ViewModel -->
        <Grid Background="#1A000000" Panel.ZIndex="99">
            <Grid.Style>
                <Style TargetType="Grid">
                    <!-- افتراضياً: Visible -->
                    <Setter Property="Visibility" Value="Visible"/>
                    <Style.Triggers>
                        <!-- عندما تنتهي التحميل -->
                        <DataTrigger Binding="{Binding IsLoading}" Value="False">
                            <Setter Property="Visibility" Value="Collapsed"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Grid.Style>

            <!-- بطاقة خفيفة وسط الشاشة -->
            <Border HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Background="White"
                    CornerRadius="8"
                    Padding="18"
                    BorderBrush="{StaticResource SapPanelBorder}"
                    BorderThickness="1">
                <StackPanel Orientation="Vertical" HorizontalAlignment="Center">

                    <!-- Spinner نقطي يدور -->
                    <Grid Width="42" Height="42" RenderTransformOrigin="0.5,0.5" Margin="0,0,0,10">
                        <Grid.RenderTransform>
                            <RotateTransform Angle="0"/>
                        </Grid.RenderTransform>

                        <!-- 8 نقاط حول دائرة بدرجات شفافية -->
                        <Ellipse Width="6" Height="6" Fill="{StaticResource SapBlue}" Opacity="1"   HorizontalAlignment="Center" VerticalAlignment="Top"/>
                        <Ellipse Width="6" Height="6" Fill="{StaticResource SapBlue}" Opacity="0.9" HorizontalAlignment="Right" VerticalAlignment="Top"    Margin="0,6,6,0"/>
                        <Ellipse Width="6" Height="6" Fill="{StaticResource SapBlue}" Opacity="0.8" HorizontalAlignment="Right" VerticalAlignment="Center"/>
                        <Ellipse Width="6" Height="6" Fill="{StaticResource SapBlue}" Opacity="0.7" HorizontalAlignment="Right" VerticalAlignment="Bottom"  Margin="0,0,6,6"/>
                        <Ellipse Width="6" Height="6" Fill="{StaticResource SapBlue}" Opacity="0.6" HorizontalAlignment="Center" VerticalAlignment="Bottom"/>
                        <Ellipse Width="6" Height="6" Fill="{StaticResource SapBlue}" Opacity="0.5" HorizontalAlignment="Left"  VerticalAlignment="Bottom"  Margin="6,0,0,6"/>
                        <Ellipse Width="6" Height="6" Fill="{StaticResource SapBlue}" Opacity="0.45" HorizontalAlignment="Left"  VerticalAlignment="Center"/>
                        <Ellipse Width="6" Height="6" Fill="{StaticResource SapBlue}" Opacity="0.4" HorizontalAlignment="Left"  VerticalAlignment="Top"     Margin="6,6,0,0"/>

                        <!-- حركة الدوران -->
                        <Grid.Triggers>
                            <EventTrigger RoutedEvent="Grid.Loaded">
                                <BeginStoryboard>
                                    <Storyboard RepeatBehavior="Forever">
                                        <DoubleAnimation
                                            Storyboard.TargetProperty="(UIElement.RenderTransform).(RotateTransform.Angle)"
                                            From="0" To="360" Duration="0:0:1.2" />
                                    </Storyboard>
                                </BeginStoryboard>
                            </EventTrigger>
                        </Grid.Triggers>
                    </Grid>

                    <!-- نصوص هادئة صغيرة مثل ByDesign -->
                    <TextBlock Text="جاري المعالجة..."
                               FontSize="12"
                               Foreground="#2B2F33"
                               HorizontalAlignment="Center"
                               Margin="0,0,0,2"/>
                    <TextBlock Text="يرجى الانتظار"
                               FontSize="11"
                               Foreground="#6B7280"
                               HorizontalAlignment="Center"/>
        </StackPanel>
            </Border>
        </Grid>
    </Grid>
</Page>
