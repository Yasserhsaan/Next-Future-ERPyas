# مسارات ترحيل الأرصدة الافتتاحية في Next ERP

يوضح هذا المستند طريقتين معتمدتين للتعامل مع الأرصدة الافتتاحية داخل Next ERP، وكيفية تفاعل كل مسار مع الخدمات والبيانات المتاحة في النظام.

## 1. المسار التمهيدي عبر سند اليومية اليدوي

هذا المسار يركّز على بناء دفعات افتتاحية قابلة للمراجعة داخل جداول `OpeningBalanceBatch` و`OpeningBalanceLine` قبل الترحيل النهائي إلى الأستاذ العام.

- **هيكل البيانات:** يعرّف النموذج `OpeningBalanceBatch` معلومات الرأس مثل الشركة، الفرع، السنة المالية، رقم المستند، تاريخ القيد، الحالة (مسودة/مُرحّل)، ومعلومات الأثر التشغيلي. 【F:Next-Future-ERP/Features/Accounts/Models/OpeningBalanceBatch.cs†L9-L45】
- **سطور الدفعة:** يحتفظ النموذج `OpeningBalanceLine` بتفاصيل الحساب، العملات، المبالغ (عملة الحركة وعملة الشركة)، مراكز التكلفة، وسريان التحقق التلقائي لضمان جانب واحد مدين أو دائن فقط لكل سطر. 【F:Next-Future-ERP/Features/Accounts/Models/OpeningBalanceLine.cs†L9-L147】
- **الخدمات المرتبطة:** يتولى `OpeningBalanceService` إنشاء أو تحديث المسودات (`CreateOrUpdateDraftAsync`) مع توليد رقم المستند وإعادة بناء السطور، بالإضافة إلى ترحيل الدفعة (`PostBatchAsync`) بعد التحقق من توازنها وربط العملات مع الحسابات. 【F:Next-Future-ERP/Features/Accounts/Services/OpeningBalanceService.cs†L20-L87】【F:Next-Future-ERP/Features/Accounts/Services/OpeningBalanceService.cs†L89-L159】
- **تحديث الأرصدة المجمّعة:** أثناء الترحيل، يتم تجميع السطور وتحديث جدول `AccountBalances` عبر الدالة `UpdateAccountBalancesAsync` لضبط أرصدة الافتتاح والختام للسنة المالية المحددة. 【F:Next-Future-ERP/Features/Accounts/Services/OpeningBalanceService.cs†L399-L462】【F:Next-Future-ERP/Features/Accounts/Models/AccountBalance.cs†L7-L71】

### مزايا المسار التمهيدي
- يوفر نقطة تحكم وحوكمة بفضل حالات المسودة والترحيل، مع إمكانية مراجعة البيانات أو حذف المسودات قبل اعتمادها. 【F:Next-Future-ERP/Features/Accounts/Services/OpeningBalanceService.cs†L161-L236】
- يسمح بعمليات تحقق إضافية (توازن المبالغ، صحة السطور) قبل السماح بالترحيل النهائي. 【F:Next-Future-ERP/Features/Accounts/Services/OpeningBalanceService.cs†L238-L329】
- يمكن توسيعه لفتح نافذة تحرير خاصة (`OpeningBalanceEditWindow`) تدير نفس الدفعات والخدمات، مما يمنح المستخدم تجربة متكاملة للمراجعة. 【F:Next-Future-ERP/Features/Accounts/Views/OpeningBalanceView/OpeningBalanceEditWindow.xaml.cs†L13-L57】

## 2. المسار المباشر إلى الأستاذ العام

في الحالات التي تتطلب سرعة التنفيذ، يمكن تسجيل الأرصدة الافتتاحية مباشرة في جدول الأستاذ العام دون المرور بسند اليومية اليدوي.

- **نموذج الرأس:** يستخدم النظام `GeneralJournalEntry` لتخزين معلومات المستند (الشركة، الفرع، نوع المستند، الرقم المرجعي، تاريخ الترحيل، الوصف، إجماليات المدين/الدائن، حالة القيد). 【F:Next-Future-ERP/Features/Accounts/Models/GeneralJournalEntry.cs†L9-L39】
- **تفاصيل السطور:** تحفظ الكيانات `GeneralJournalEntryDetail` أرقام الحسابات، مراكز التكلفة، البيان، المبالغ، العملة، وسعر الصرف لكل سطر. 【F:Next-Future-ERP/Features/Accounts/Models/GeneralJournalEntryDetail.cs†L11-L36】
- **خدمة الترحيل:** يمكن إنشاء أو تحديث القيود مباشرة باستخدام `GeneralJournalService.SaveAsync` والذي يدير إضافة الرأس وتفاصيله في قاعدة البيانات. 【F:Next-Future-ERP/Features/Accounts/Services/GeneralJournalService.cs†L13-L61】

### خصائص المسار المباشر
- يقلّل عدد الخطوات للمستخدمين ذوي الصلاحية العالية عندما تكون الأرصدة جاهزة للترحيل دون الحاجة إلى دورة مراجعة داخلية.
- يعتمد على نفس تكوين أنواع المستندات ونوافذ إدخال الأستاذ العام المستخدمة للحركات اليومية الأخرى، مما يسهل إعادة الاستخدام.

## 3. تلخيص الأثر في جدول AccountBalances

بغضّ النظر عن المسار المختار، فإن جدول `AccountBalances` يمثّل المصدر النهائي لتجميع أرصدة الافتتاح والفترة والإقفال لكل بُعد (شركة/فرع/حساب/عملة/مركز تكلفة اختياري). يحتوي النموذج على حقول صريحة للمدين والدائن لكل مرحلة، بالإضافة إلى خصائص محسوبة للناتج الصافي. 【F:Next-Future-ERP/Features/Accounts/Models/AccountBalance.cs†L7-L68】

عند استخدام المسار التمهيدي، يتم تحديث الجدول تلقائيًا أثناء استدعاء `UpdateAccountBalancesAsync`. في المسار المباشر، يتعيّن على المنفّذ تحديث هذا الجدول (أو استدعاء خدمة مشابهة) لضمان تطابق التقارير مع القيود المرحّلة.

## 4. اختيار المسار المناسب

- استخدم **المسار التمهيدي** عندما تحتاج إلى دورة اعتماد متعددة الخطوات، سجلات تدقيق أعمق، أو رغبت في السماح للمستخدمين بإعادة تحميل الملفات واستيرادها قبل النشر النهائي.
- استخدم **المسار المباشر** للعمليات السريعة أو عند تنفيذ عمليات تصحيح تحت إشراف المستخدمين المخولين، مع تذكّر مزامنة أرصدة الحسابات بعد إدخال القيود.

يتيح هذا التباين مرونة في حوكمة الأرصدة الافتتاحية بما يتناسب مع سياسات كل مؤسسة، مع الحفاظ على تكامل بيانات الأستاذ العام وملخص الأرصدة.
