<Window x:Class="Next_Future_ERP.Features.Accounts.Views.ReceiptVoucherEditWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:models="clr-namespace:Next_Future_ERP.Models"
        xmlns:sys="clr-namespace:System;assembly=System.Runtime"
        Title="{Binding WindowTitle}" Height="900" Width="1200"
        WindowStartupLocation="CenterOwner"
        FlowDirection="RightToLeft"
        Background="#F7F9FC"
        ResizeMode="CanResizeWithGrip"
        MinWidth="1000" MinHeight="700"
        Loaded="Window_Loaded">

    <Window.InputBindings>
        <KeyBinding Key="S" Modifiers="Ctrl" Command="{Binding SaveAsyncCommand}"/>
        <KeyBinding Key="Escape" Command="{Binding CancelCommand}"/>
    </Window.InputBindings>

    <Window.Resources>
        <!-- Ø£Ù„ÙˆØ§Ù† Ù…Ø­Ù„ÙŠØ© Ø¢Ù…Ù†Ø© -->
        <SolidColorBrush x:Key="AccentBrush" Color="#FF34A7A9"/>
        <SolidColorBrush x:Key="AccentTextBrush" Color="#000000"/>
        <SolidColorBrush x:Key="CardBorderBrush" Color="#E5E7EB"/>
        <SolidColorBrush x:Key="CardBackgroundBrush" Color="#FFFFFFFF"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#10B981"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF4444"/>

        <!-- Ù‚ÙŠÙ… enum Ù„Ù†ÙˆØ¹ Ø§Ù„Ø³Ù†Ø¯ -->
        <ObjectDataProvider x:Key="VoucherTypeValues"
                            MethodName="GetValues"
                            ObjectType="{x:Type sys:Enum}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="models:VoucherType"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>

        <BooleanToVisibilityConverter x:Key="BoolToVisibility"/>

        <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø´Ø±ÙŠØ· -->
        <Style x:Key="IconButton" TargetType="Button">
            <Setter Property="Padding" Value="8,6"/>
            <Setter Property="Margin" Value="0,0,8,0"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="MinWidth" Value="80"/>
        </Style>

        <!-- ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ù„ØµÙ‚Ø§Øª ÙˆØ§Ù„Ø­Ù‚ÙˆÙ„ -->
        <Style x:Key="FormLabel" TargetType="TextBlock">
            <Setter Property="Margin" Value="0,0,0,4"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
        </Style>
        <Style x:Key="RightAlignedText" TargetType="TextBlock">
            <Setter Property="TextAlignment" Value="Right"/>
            <Setter Property="HorizontalAlignment" Value="Stretch"/>
        </Style>
        <Style x:Key="RightAlignedTextBox" TargetType="TextBox">
            <Setter Property="TextAlignment" Value="Right"/>
            <Setter Property="HorizontalContentAlignment" Value="Right"/>
        </Style>

        <!-- GroupBox Ø¨Ø´ÙƒÙ„ Ø¨Ø·Ø§Ù‚Ø© -->
        <Style TargetType="GroupBox">
            <Setter Property="Margin" Value="0,8,0,8"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="BorderBrush" Value="{StaticResource CardBorderBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="GroupBox">
                        <Border BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                Background="{StaticResource CardBackgroundBrush}"
                                CornerRadius="10">
                            <DockPanel>
                                <Border Background="{StaticResource AccentBrush}"
                                        CornerRadius="10,10,0,0"
                                        Padding="10,6"
                                        DockPanel.Dock="Top">
                                    <TextBlock Text="{TemplateBinding Header}"
                                               Foreground="{StaticResource AccentTextBrush}"
                                               FontWeight="SemiBold"/>
                                </Border>
                                <ContentPresenter Margin="10"/>
                            </DockPanel>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- DataGrid ØªØ­Ø³ÙŠÙ†Ø§Øª -->
        <Style TargetType="DataGrid">
            <Setter Property="RowHeight" Value="34"/>
            <Setter Property="HeadersVisibility" Value="Column"/>
            <Setter Property="GridLinesVisibility" Value="Horizontal"/>
            <Setter Property="BorderBrush" Value="{StaticResource CardBorderBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="AlternationCount" Value="2"/>
        </Style>

        <Style TargetType="DataGridRow">
            <Setter Property="Background" Value="{x:Null}"/>
            <Style.Triggers>
                <Trigger Property="ItemsControl.AlternationIndex" Value="1">
                    <Setter Property="Background" Value="#FFF7F7F7"/>
                </Trigger>
            </Style.Triggers>
        </Style>
    </Window.Resources>

    <!-- =================== Main Layout =================== -->
    <DockPanel>
        <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø³ÙÙ„ÙŠ -->
        <Border DockPanel.Dock="Bottom" 
                Background="{StaticResource CardBackgroundBrush}"
                BorderBrush="{StaticResource CardBorderBrush}"
                BorderThickness="0,1,0,0"
                Padding="16,12">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                <Button Content="ðŸ’¾ Ø­ÙØ¸" 
                        Command="{Binding SaveAsyncCommand}" 
                        Style="{StaticResource IconButton}"
                        Background="{StaticResource AccentBrush}"
                        Foreground="White"
                        MinWidth="120"/>
                <Separator Width="1" Height="24" Background="{StaticResource CardBorderBrush}" Margin="8,0"/>
                <Button Content="Ø¥Ù„ØºØ§Ø¡" 
                        Command="{Binding CancelCommand}" 
                        Style="{StaticResource IconButton}"
                        MinWidth="100"/>
            </StackPanel>
        </Border>

        <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
        <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="16">
            <StackPanel>
                <!-- ========= Main / Header data ========= -->
                <GroupBox Header="Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" Margin="0,0,0,8">
                    <Grid Margin="10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="8"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="24"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="8"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="8"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="8"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="8"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="8"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- Branch -->
                        <TextBlock Style="{StaticResource FormLabel}" Text="Ø§Ù„ÙØ±Ø¹"/>
                        <ComboBox Grid.Column="2"
                                  ItemsSource="{Binding BranchOptions}"
                                  SelectedValue="{Binding SelectedBranchId, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                  SelectedValuePath="BranchId"
                                  DisplayMemberPath="BranchName"
                                  MinWidth="200"
                                  IsEnabled="{Binding IsHeaderEnabled}"/>

                        <!-- Voucher Type -->
                        <TextBlock Grid.Column="4" Style="{StaticResource FormLabel}" Text="Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø¨Ø¶"/>
                        <ComboBox Grid.Column="6"
                                  ItemsSource="{Binding Source={StaticResource VoucherTypeValues}}"
                                  SelectedValue="{Binding VoucherType, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                  SelectedValuePath="."
                                  MinWidth="140"
                                  IsEnabled="{Binding IsHeaderEnabled}"/>

                        <!-- Cash -->
                        <TextBlock Grid.Row="2" Style="{StaticResource FormLabel}" Text="Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚"
                                   Visibility="{Binding IsCash, Converter={StaticResource BoolToVisibility}}"/>
                        <ComboBox Grid.Row="2" Grid.Column="2"
                                  ItemsSource="{Binding CashBoxOptions}"
                                  SelectedValue="{Binding SelectedCashBoxId, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                  SelectedValuePath="FundId"
                                  DisplayMemberPath="FundName"
                                  MinWidth="200"
                                  Visibility="{Binding IsCash, Converter={StaticResource BoolToVisibility}}"
                                  IsEnabled="{Binding IsCashListEnabled}"/>

                        <!-- Bank -->
                        <TextBlock Grid.Row="2" Grid.Column="4" Style="{StaticResource FormLabel}" Text="Ø§Ù„Ø¨Ù†Ùƒ"
                                   Visibility="{Binding IsCheque, Converter={StaticResource BoolToVisibility}}"/>
                        <ComboBox Grid.Row="2" Grid.Column="6"
                                  ItemsSource="{Binding BankOptions}"
                                  SelectedValue="{Binding SelectedBankId, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                  SelectedValuePath="BankId"
                                  DisplayMemberPath="BankName"
                                  MinWidth="200"
                                  Visibility="{Binding IsCheque, Converter={StaticResource BoolToVisibility}}"
                                  IsEnabled="{Binding IsBankListEnabled}"/>

                        <!-- Currency -->
                        <TextBlock Grid.Row="4" Style="{StaticResource FormLabel}" Text="Ø§Ù„Ø¹Ù…Ù„Ø©"/>
                        <ComboBox Grid.Row="4" Grid.Column="2"
                                  ItemsSource="{Binding CurrencyOptions}"
                                  SelectedValue="{Binding SelectedCurrencyId, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                  SelectedValuePath="CurrencyId"
                                  DisplayMemberPath="CurrencyNameAr"
                                  MinWidth="200"
                                  IsEnabled="{Binding IsHeaderEnabled}"/>

                        <!-- Exchange rate -->
                        <TextBlock Grid.Row="4" Grid.Column="4" Style="{StaticResource FormLabel}" Text="Ø³Ø¹Ø± Ø§Ù„ØªØ­ÙˆÙŠÙ„"/>
                        <StackPanel Grid.Row="4" Grid.Column="6" Orientation="Horizontal">
                            <TextBox Width="120"
                                     Text="{Binding Voucher.ExchangeRate, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource RightAlignedTextBox}"
                                     IsEnabled="{Binding IsHeaderEnabled}"/>
                            <Button Content="ØªØ­Ø¯ÙŠØ«" Margin="8,0,0,0"
                                    Command="{Binding CurrencyChangedAsyncCommand}"
                                    IsEnabled="{Binding IsHeaderEnabled}"/>
                        </StackPanel>

                        <!-- Doc type / number / date / beneficiary -->
                        <TextBlock Grid.Row="6" Style="{StaticResource FormLabel}" Text="Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯"/>
                        <ComboBox Grid.Row="6" Grid.Column="2"
                                  ItemsSource="{Binding DocumentTypeOptions}"
                                  SelectedValue="{Binding Voucher.DocumentTypeID, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                  SelectedValuePath="DocumentTypeId"
                                  MinWidth="200"
                                  IsEnabled="{Binding IsHeaderEnabled}">
                            <ComboBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock>
                                        <TextBlock.Text>
                                            <PriorityBinding>
                                                <Binding Path="DocumentNameAr"/>
                                                <Binding Path="DocumentTypeName"/>
                                                <Binding Path="NameAr"/>
                                                <Binding Path="NameEn"/>
                                                <Binding Path="Name"/>
                                                <Binding Path="Title"/>
                                                <Binding FallbackValue="Ù†ÙˆØ¹ Ù…Ø³ØªÙ†Ø¯"/>
                                            </PriorityBinding>
                                        </TextBlock.Text>
                                    </TextBlock>
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>

                        <TextBlock Grid.Row="6" Grid.Column="4" Style="{StaticResource FormLabel}" Text="Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙ†Ø¯"/>
                        <TextBox Grid.Row="6" Grid.Column="6"
                                 Text="{Binding Voucher.DocumentNumber}"
                                 IsReadOnly="True" IsEnabled="False"/>

                        <TextBlock Grid.Row="8" Style="{StaticResource FormLabel}" Text="ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø³ØªÙ†Ø¯"/>
                        <DatePicker Grid.Row="8" Grid.Column="2"
                                    SelectedDate="{Binding Voucher.DocumentDate, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                    IsEnabled="{Binding IsHeaderEnabled}"/>

                        <TextBlock Grid.Row="8" Grid.Column="4" Style="{StaticResource FormLabel}" Text="Ø§Ù„Ù…Ø³ØªÙÙŠØ¯"/>
                        <TextBox Grid.Row="8" Grid.Column="6"
                                 Text="{Binding Voucher.Beneficiary, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                 IsEnabled="{Binding IsHeaderEnabled}"/>
                    </Grid>
                </GroupBox>

                <!-- ========= Details ========= -->
                <GroupBox Header="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù‚ÙŠØ¯">
                    <DockPanel>
                        <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="0,0,0,8">
                            <Button Content="âž• Ø¥Ø¶Ø§ÙØ© ØµÙ" 
                                    Command="{Binding AddRowCommand}" 
                                    IsEnabled="{Binding IsEditing}"
                                    Style="{StaticResource IconButton}"
                                    Background="{StaticResource SuccessBrush}"
                                    Foreground="White"/>
                        </StackPanel>

                        <DataGrid ItemsSource="{Binding DetailRows}"
                                  AutoGenerateColumns="False"
                                  CanUserAddRows="False"
                                  IsReadOnly="{Binding IsView}">
                            <DataGrid.Columns>
                                <!-- Account -->
                                <DataGridTemplateColumn Header="Ø§Ù„Ø­Ø³Ø§Ø¨" MinWidth="220">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <ComboBox ItemsSource="{Binding DataContext.AccountOptions, RelativeSource={RelativeSource AncestorType=Window}}"
                                                      SelectedValuePath="AccountId"
                                                      DisplayMemberPath="AccountNameAr"
                                                      SelectedValue="{Binding AccountID, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>

                                <!-- Cost center -->
                                <DataGridTemplateColumn Header="Ù…Ø±ÙƒØ² ØªÙƒÙ„ÙØ©" MinWidth="160">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <ComboBox ItemsSource="{Binding DataContext.CostCenterOptions, RelativeSource={RelativeSource AncestorType=Window}}"
                                                      SelectedValuePath="CostCenterId"
                                                      DisplayMemberPath="CostCenterName"
                                                      SelectedValue="{Binding CostCenterID, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>

                                <!-- Ø³Ù†Ø¯ Ù‚Ø¨Ø¶: Ù…Ø¨Ø§Ù„Øº (Ø¯Ø§Ø¦Ù†) ÙÙ‚Ø· -->
                                <DataGridTextColumn Header="Ø§Ù„Ù…Ø¨Ù„Øº (Ø¹Ù…Ù„Ø© Ø£Ø¬Ù†Ø¨ÙŠØ©)"
                                                    Binding="{Binding CreditCurncy, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, StringFormat=N3}"
                                                    MinWidth="160">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock" BasedOn="{StaticResource RightAlignedText}"/>
                                    </DataGridTextColumn.ElementStyle>
                                    <DataGridTextColumn.EditingElementStyle>
                                        <Style TargetType="TextBox" BasedOn="{StaticResource RightAlignedTextBox}"/>
                                    </DataGridTextColumn.EditingElementStyle>
                                </DataGridTextColumn>

                                <DataGridTextColumn Header="Ø§Ù„Ù…Ø¨Ù„Øº (Ø¹Ù…Ù„Ø© Ø§Ù„Ø´Ø±ÙƒØ©)"
                                                    Binding="{Binding CrediComptCurncy, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, StringFormat=N3}"
                                                    MinWidth="160">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock" BasedOn="{StaticResource RightAlignedText}"/>
                                    </DataGridTextColumn.ElementStyle>
                                    <DataGridTextColumn.EditingElementStyle>
                                        <Style TargetType="TextBox" BasedOn="{StaticResource RightAlignedTextBox}"/>
                                    </DataGridTextColumn.EditingElementStyle>
                                </DataGridTextColumn>

                                <!-- Description -->
                                <DataGridTextColumn Header="Ø§Ù„ÙˆØµÙ"
                                                    Binding="{Binding Description, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                    MinWidth="220"/>

                                <!-- Delete row -->
                                <DataGridTemplateColumn Header="Ø­Ø°Ù" Width="64">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <Button Command="{Binding DataContext.RemoveRowCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                    CommandParameter="{Binding}"
                                                    ToolTip="Ø­Ø°Ù Ø§Ù„ØµÙ"
                                                    IsEnabled="{Binding DataContext.IsEditing, RelativeSource={RelativeSource AncestorType=Window}}">
                                                <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE74D;"/>
                                            </Button>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                            </DataGrid.Columns>
                        </DataGrid>
                    </DockPanel>
                </GroupBox>

                <!-- ========= Status ========= -->
                <StatusBar Margin="0,8,0,0">
                    <StatusBarItem>
                        <TextBlock Text="{Binding Voucher.LocalAmount, StringFormat=Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­Ù„ÙŠ: {0:N3}}"/>
                    </StatusBarItem>
                    <StatusBarItem>
                        <TextBlock Text="{Binding Voucher.ForeignAmount, StringFormat=Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø£Ø¬Ù†Ø¨ÙŠ: {0:N3}}"/>
                    </StatusBarItem>
                    <StatusBarItem>
                        <CheckBox Content="Ù…Ø±Ø§Ø¬ÙŽØ¹" IsChecked="{Binding Voucher.IsReviewed, Mode=TwoWay}" IsEnabled="{Binding IsHeaderEnabled}"/>
                    </StatusBarItem>
                    <StatusBarItem>
                        <CheckBox Content="Ù…ÙØ±Ø­Ù‘Ù„" IsChecked="{Binding Voucher.IsPosted, Mode=TwoWay}" IsEnabled="{Binding IsHeaderEnabled}"/>
                    </StatusBarItem>
                    <StatusBarItem>
                        <CheckBox Content="Ù…ÙØ¹Ù„Ù‘Ù‚" IsChecked="{Binding Voucher.IsSuspended, Mode=TwoWay}" IsEnabled="{Binding IsHeaderEnabled}"/>
                    </StatusBarItem>
                </StatusBar>
            </StackPanel>
        </ScrollViewer>
    </DockPanel>
</Window>

