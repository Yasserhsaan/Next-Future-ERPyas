<UserControl x:Class="Next_Future_ERP.Features.Accounts.Controls.AccountSearchBox"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             mc:Ignorable="d" 
             d:DesignHeight="32" d:DesignWidth="300">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- صندوق البحث -->
        <Border Grid.Row="0" 
                BorderBrush="#E5E5E5" 
                BorderThickness="1" 
                CornerRadius="4"
                Background="White">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <TextBox x:Name="SearchTextBox"
                         Grid.Column="0"
                         Text="{Binding RelativeSource={RelativeSource AncestorType=UserControl}, Path=SearchText, UpdateSourceTrigger=PropertyChanged}"
                         BorderThickness="0"
                         Background="Transparent"
                         Margin="8,6"
                         VerticalAlignment="Center"
                         FontSize="13"
                         FlowDirection="RightToLeft"
                         TextChanged="SearchTextBox_TextChanged"
                         PreviewKeyDown="SearchTextBox_PreviewKeyDown"
                         GotFocus="SearchTextBox_GotFocus"
                         LostFocus="SearchTextBox_LostFocus">
                    <TextBox.Style>
                        <Style TargetType="TextBox">
                            <Style.Triggers>
                                <Trigger Property="Text" Value="">
                                    <Setter Property="Background">
                                        <Setter.Value>
                                            <VisualBrush AlignmentX="Right" AlignmentY="Center" Stretch="None">
                                                <VisualBrush.Visual>
                                                    <StackPanel Orientation="Horizontal" FlowDirection="RightToLeft">
                                                        <TextBlock Text="ابحث بالرقم أو الاسم" 
                                                                   Foreground="#A0A0A0" 
                                                                   FontSize="13" 
                                                                   Margin="4,0,8,0"/>
                                                        <Border Background="#E3F2FD" 
                                                                CornerRadius="3" 
                                                                Padding="4,1">
                                                            <TextBlock Text="F1 للبحث" 
                                                                       Foreground="#1976D2" 
                                                                       FontSize="10" 
                                                                       FontWeight="SemiBold"/>
                                                        </Border>
                                                    </StackPanel>
                                                </VisualBrush.Visual>
                                            </VisualBrush>
                                        </Setter.Value>
                                    </Setter>
                                </Trigger>
                                <!-- حالة التركيز -->
                                <MultiTrigger>
                                    <MultiTrigger.Conditions>
                                        <Condition Property="Text" Value=""/>
                                        <Condition Property="IsFocused" Value="True"/>
                                    </MultiTrigger.Conditions>
                                    <Setter Property="Background">
                                        <Setter.Value>
                                            <VisualBrush AlignmentX="Right" AlignmentY="Center" Stretch="None">
                                                <VisualBrush.Visual>
                                                    <StackPanel Orientation="Horizontal" FlowDirection="RightToLeft">
                                                        <TextBlock Text="اكتب للبحث المباشر أو " 
                                                                   Foreground="#757575" 
                                                                   FontSize="12" 
                                                                   Margin="4,0,4,0"/>
                                                        <Border Background="#4CAF50" 
                                                                CornerRadius="3" 
                                                                Padding="6,2">
                                                            <TextBlock Text="F1 للبحث المتقدم" 
                                                                       Foreground="White" 
                                                                       FontSize="10" 
                                                                       FontWeight="SemiBold"/>
                                                        </Border>
                                                    </StackPanel>
                                                </VisualBrush.Visual>
                                            </VisualBrush>
                                        </Setter.Value>
                                    </Setter>
                                </MultiTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBox.Style>
                </TextBox>
                
                <Button x:Name="SearchButton"
                        Grid.Column="1"
                        Width="24" Height="24"
                        Margin="4"
                        BorderThickness="0"
                        Background="Transparent"
                        Click="SearchButton_Click">
                    <Path Data="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" 
                          Fill="#666666" 
                          Stretch="Uniform"/>
                </Button>
            </Grid>
        </Border>
        
        <!-- قائمة النتائج -->
        <Popup x:Name="ResultsPopup"
               Grid.Row="1"
               PlacementTarget="{Binding ElementName=SearchTextBox}"
               Placement="Bottom"
               StaysOpen="False"
               MaxHeight="300"
               Width="{Binding ActualWidth, ElementName=SearchTextBox}"
               PopupAnimation="Slide">
            <Border Background="White" 
                    BorderBrush="#E5E5E5" 
                    BorderThickness="1" 
                    CornerRadius="4">
                <ScrollViewer MaxHeight="280" VerticalScrollBarVisibility="Auto">
                    <ItemsControl x:Name="ResultsItemsControl"
                                  ItemsSource="{Binding RelativeSource={RelativeSource AncestorType=UserControl}, Path=SearchResults}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="Transparent" 
                                        Cursor="Hand"
                                        MouseLeftButtonDown="ResultItem_MouseLeftButtonDown"
                                        Tag="{Binding}">
                                    <Border.Style>
                                        <Style TargetType="Border">
                                            <Style.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="Background" Value="#F0F7FF"/>
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>
                                    
                                    <StackPanel Margin="12,8" FlowDirection="RightToLeft">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            
                                            <TextBlock Grid.Column="0"
                                                       Text="{Binding AccountCode}"
                                                       FontWeight="SemiBold"
                                                       FontSize="13"
                                                       Foreground="#2563EB"
                                                       Margin="0,0,12,0"/>
                                            
                                            <TextBlock Grid.Column="1"
                                                       Text="{Binding AccountNameAr}"
                                                       FontSize="13"
                                                       Foreground="#374151"
                                                       TextTrimming="CharacterEllipsis"/>
                                            
                                            <Border Grid.Column="2"
                                                    Background="#EEF2FF"
                                                    CornerRadius="12"
                                                    Padding="6,2"
                                                    Margin="8,0,0,0">
                                                <TextBlock Text="{Binding AccountCategoryKey}"
                                                           FontSize="10"
                                                           Foreground="#6366F1"
                                                           FontWeight="Medium"/>
                                            </Border>
                                        </Grid>
                                        
                                        <TextBlock Text="{Binding AccountNameEn}"
                                                   FontSize="11"
                                                   Foreground="#9CA3AF"
                                                   Margin="0,2,0,0"/>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Border>
        </Popup>
    </Grid>
</UserControl>
